<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <video class="localVideo" height="200" width="200"></video>
    <video class="remoteVideo" height="200" width="200"></video>
    <button onclick="connect()">connect</button>
    <button onclick="disconnect()">disconnect</button>
    <button onclick="getStream()">getStream</button>
    <script>
        let localVideo = document.querySelector('.localVideo');
        let remoteVideo = document.querySelector('.remoteVideo');
        let localConnection = new RTCPeerConnection()
        let remoteConnection = new RTCPeerConnection()
        let localStream = new MediaStream();
        localConnection.ontrack = e => {
            console.log('localConnectionontrack')
        }
        remoteConnection.ontrack = e => {
            console.log('remoteOntrack', e)
            remoteVideo.srcObject = e.streams[0]
            remoteVideo.play()
        }

        localConnection.onicecandidate = e => {
            if (e.candidate) {
                console.log('localConnectionicecandidate', e.candidate)
                remoteConnection.addIceCandidate(e.candidate)
            }
        }

        remoteConnection.onicecandidate = e => {
            if (e.candidate) {
                console.log('remoteConnectionicecandidate', e.candidate)
                localConnection.addIceCandidate(e.candidate)
            }
        }

        async function connect() {
            localConnection.createOffer()
            .then(offer => localConnection.setLocalDescription(offer))
            .then(() => remoteConnection.setRemoteDescription(localConnection.localDescription))
            .then(() => remoteConnection.createAnswer())
            .then(answer => remoteConnection.setLocalDescription(answer))
            .then(() => localConnection.setRemoteDescription(remoteConnection.localDescription))
            .catch(handleCreateDescriptionError);
        }

        function handleCreateDescriptionError(error) {
            console.log('handleCreateDescriptionError', error)
        }

        function disconnect() {
            localVideo.srcObject = null;
            localConnection = null;
            remoteConnection = null;
        }

        async function getStream() {
            let stream = await navigator.mediaDevices.getDisplayMedia({
                video: true,
                audio: false
            })
            localVideo.srcObject = stream
            localVideo.play()
            localStream = stream
            localStream.getTracks().forEach(track => {
                localConnection.addTrack(track, localStream)
            })
        }
    </script>
    
</body>
</html>